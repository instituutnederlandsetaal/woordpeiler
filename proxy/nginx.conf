events {}

http {
log_format cache_status '$remote_addr - $remote_user [$time_local] "$request" status=$status upstream_cache_status=$upstream_cache_status bytes_sent=$body_bytes_sent "$http_referer" "$http_user_agent"';
access_log /var/log/nginx/access.log cache_status;

# cache
proxy_cache_path /tmp/backend_word_cache keys_zone=backend_word_cache:4m max_size=500m inactive=1d;
proxy_cache_path /tmp/backend_static_cache keys_zone=backend_static_cache:1m max_size=10m inactive=1d;
proxy_cache_path /tmp/backend_trends_cache keys_zone=backend_trends_cache:1m max_size=100m inactive=1d;
proxy_cache_path /tmp/frontend_cache keys_zone=frontend_cache:1m max_size=10m inactive=1y;

# rate limiting
limit_req_zone $binary_remote_addr zone=mylimit:10m rate=80r/s;

server {
    listen   80;
    listen   [::]:80 default ipv6only=on;

    root /usr/share/nginx/html;
    index index.html;

    # timeouts
    proxy_send_timeout 3600;
    proxy_read_timeout 3600;
    fastcgi_send_timeout 3600;
    fastcgi_read_timeout 3600;

    # all hostnames
    server_name _;

    # cache
    proxy_hide_header Cache-Control;
    proxy_ignore_headers Expires Cache-Control Set-Cookie Vary;

    # Reverse proxies for the backend
    location /api/ {
        proxy_pass http://server:8000/;
        proxy_set_header X-Forwarded-Host localhost;
        proxy_set_header X-Forwarded-Proto http;
    }

    # cache word freq
    location /api/word_frequency {
        # rate limiting
        limit_req zone=mylimit burst=25 nodelay;

        proxy_pass http://server:8000/word_frequency;
        proxy_cache backend_word_cache;
        proxy_cache_valid 200 1d;
        add_header Cache-Control "max-age=86400, public";
    }

    # cache svg
    location /api/svg {
        # rate limiting
        limit_req zone=mylimit burst=12 nodelay;

        proxy_pass http://server:8000/svg;
        proxy_cache backend_static_cache; # static cache
        proxy_cache_valid 200 1d;
        add_header Cache-Control "max-age=86400, public";
    }

    # cache sources
    location /api/sources {
        proxy_pass http://server:8000/sources;
        proxy_cache backend_static_cache;
        proxy_cache_valid 200 1d;
        add_header Cache-Control "max-age=86400, public";
    }

    # cache posses
    location /api/posses {
        proxy_pass http://server:8000/posses;
        proxy_cache backend_static_cache;
        proxy_cache_valid 200 1d;
        add_header Cache-Control "max-age=86400, public";
    }

    # cache posheads
    location /api/posheads {
        proxy_pass http://server:8000/posheads;
        proxy_cache backend_static_cache;
        proxy_cache_valid 200 1d;
        add_header Cache-Control "max-age=86400, public";
    }

    # cache trends
    location /api/trends {
        proxy_pass http://server:8000/trends;
        proxy_cache backend_trends_cache;
        proxy_cache_valid 200 1d;
        add_header Cache-Control "max-age=86400, public";
    }



    # Reverse proxy for the frontend
    location / {
        proxy_pass http://client:8080/;
        proxy_cache frontend_cache;
        proxy_cache_valid 200 1y;
        add_header Cache-Control "max-age=31536000, public";
    }
	
	location /favicon.ico {
		proxy_pass http://client:8080/woordpeiler-logo.png;
        proxy_cache frontend_cache;
        proxy_cache_valid 200 1y;
        add_header Cache-Control "max-age=31536000, public";
	}
	
	location /apple-touch-icon.png {
		proxy_pass http://client:8080/woordpeiler-logo.png;
        proxy_cache frontend_cache;
        proxy_cache_valid 200 1y;
        add_header Cache-Control "max-age=31536000, public";
	}
	
	location /apple-touch-icon-precomposed.png {
		proxy_pass http://client:8080/woordpeiler-logo.png;
        proxy_cache frontend_cache;
        proxy_cache_valid 200 1y;
        add_header Cache-Control "max-age=31536000, public";
	}

    location /grafiek {
        proxy_pass http://client:8080/;
        proxy_cache frontend_cache;
        proxy_cache_valid 200 1y;
        proxy_cache_key "root";
        add_header Cache-Control "max-age=31536000, public";
    }

    location /assets {
        proxy_pass http://client:8080/assets;
        proxy_cache frontend_cache;
        proxy_cache_valid 200 1y;
        add_header Cache-Control "max-age=31536000, public";
    }

}
}